# 服务器文件管理模块开发方案

为实现网页端对服务器文件的全面管理（上传、下载、删除、压缩/解压），建议基于 **SFTP (JSch)** 和 **SSH 命令执行** 来构建此模块。

## 1. 核心技术选型
*   **文件操作 (SFTP)**：使用 `JSch` 的 `ChannelSftp` 实现文件列表获取、上传、下载、删除、重命名等操作。SFTP 协议成熟稳定，天然支持文件属性获取。
*   **压缩/解压 (SSH Shell)**：由于 SFTP 协议本身不支持服务端压缩/解压，这部分功能将通过 `JSch` 的 `ChannelExec` 执行 Linux 命令（`tar`, `zip`, `unzip`）来实现。这比将文件下载到本地处理再上传要高效得多。

## 2. 功能模块设计

### 2.1 后端架构 (`ruoyi-admin`)
*   **Controller**: `OpsFileController`
    *   `/ops/file/list`: 获取指定目录下的文件列表（包含名称、大小、权限、修改时间）。
    *   `/ops/file/upload`: 上传文件（支持 MultipartFile）。
    *   `/ops/file/download`: 下载文件（流式传输）。
    *   `/ops/file/delete`: 删除文件或递归删除文件夹。
    *   `/ops/file/compress`: 执行压缩命令 (tar/zip)。
    *   `/ops/file/extract`: 执行解压命令 (tar/unzip)。
*   **Service**: `OpsFileService`
    *   封装 JSch 连接池或短连接管理，确保高性能和连接释放。
    *   实现 SFTP 和 Exec 通道的复用逻辑。

### 2.2 前端架构 (`ruoyi-ui`)
*   **路由**: `/ops/server/file/:serverId`
*   **组件**: `FileButton` (在服务器列表增加“文件”按钮) -> `FileManager.vue`
*   **UI 交互**:
    *   **面包屑导航**: 显示当前路径，支持点击跳转上级。
    *   **文件列表**: 表格展示，支持按名称、大小、时间排序。图标区分文件/文件夹。
    *   **右键菜单/操作栏**: 提供 下载、删除、重命名、压缩、解压 选项。
    *   **上传组件**: 支持拖拽上传，显示进度条。

## 3. 关键实现细节建议

1.  **路径安全性**: 必须校验路径参数，防止 `../` 越权访问非授权目录（尽管是 root 权限，但在业务层应限制范围，如默认为 `/root` 或 `/home`）。
2.  **大文件处理**:
    *   **下载**: 使用 `HttpServletResponse` 的 `OutputStream` 直接对接 SFTP 的 `InputStream`，实现流式下载，避免内存溢出。
    *   **上传**: 同样使用流式写入，对于超大文件可考虑分片上传（作为进阶功能）。
3.  **压缩/解压策略**:
    *   **智能识别**: 根据文件后缀 (`.tar.gz`, `.zip`) 自动匹配解压命令。
    *   **异步执行**: 压缩大文件夹可能耗时，建议后端异步执行并返回任务 ID，或前端增加 Loading 遮罩。

## 4. 实施步骤
1.  **后端**: 创建 `OpsFileController` 和 `OpsFileService`，实现基础的 `ls` (list) 和 SFTP 连接工具类。
2.  **后端**: 实现上传、下载、删除接口。
3.  **后端**: 实现 `execCommand` 方法，封装 `tar -czvf` 等命令用于压缩/解压。
4.  **前端**: 创建文件管理页面 `FileManager.vue`，对接后端接口。
5.  **集成**: 在服务器列表页入口增加跳转。

我将按照此方案，优先实现核心的文件列表、上传、下载和删除功能，随后实现压缩/解压。
